# Pool Server 主网连接问题 GitHub Issues

## 严重级别 P0（阻塞性问题）

### Issue #1: libp2p 连接初始化失败导致无法连接主网 （clear） ✅

**标题**: libp2p 连接初始化失败导致无法连接主网

**描述**:
当 pool-server 尝试连接到主网时，libp2p 组件无法正确初始化，导致无法与主网节点建立连接。日志显示错误：`Failed to listen on /ip4/0.0.0.0/tcp/13340: Multiaddr is not supported: /ip4/0.0.0.0/tcp/13340`，随后报告 `Could not create swarm`。

**复现步骤**:
1. 设置 `fakenet: false`
2. 配置主网节点地址
3. 启动 pool-server
4. 观察日志中的错误信息

**预期行为**:
libp2p 组件应该成功初始化并连接到主网节点。

**实际行为**:
libp2p 组件初始化失败，无法创建 swarm，导致无法连接到主网。

**可能的解决方案**:
1. 检查 libp2p 配置，确保使用支持的多地址格式
2. 考虑移除 TCP 监听，仅使用 QUIC 协议
3. 更新 libp2p 依赖版本，确保兼容性

**优先级**: 高
**标签**: bug, connectivity, p0

---

### Issue #2: 本地创世区块与主网不匹配 (clear) ✅

**标题**: 本地创世区块与主网不匹配，导致无法同步主网区块

**描述**:
即使设置了 `fakenet: false`，系统仍然使用本地创世区块初始化，而不是使用主网的创世区块。日志显示 `setting genesis seal.` 和 `Not checking btc hash for genesis block`，表明系统没有正确切换到主网模式。

**复现步骤**:
1. 设置 `fakenet: false`
2. 启动 pool-server
3. 观察日志中关于创世区块的信息

**预期行为**:
系统应该使用主网的创世区块，或者从主网节点同步创世区块。

**实际行为**:
系统使用本地创世区块，导致无法与主网链对接。

**可能的解决方案**:
1. 修改代码，确保在主网模式下使用正确的创世区块
2. 添加从主网节点获取创世区块的逻辑
3. 检查是否有硬编码的创世区块覆盖了配置

**优先级**: 高
**标签**: bug, blockchain, p0

---

## 严重级别 P1（严重问题）

### Issue #3: 协议不匹配导致连接失败

**标题**: 本地节点与主网节点协议不匹配导致连接失败 (clear) ✅

**描述**:
在配置中，主网节点地址使用的是 QUIC 协议（`/ip4/121.61.204.239/udp/3006/quic-v1/p2p/12D3KooWEjQcZUS3x5YEMuMj1kgZJyoV4MTHNRnbtbSEMAMzwGQC`），但本地节点尝试同时监听 TCP 和 QUIC。TCP 监听失败可能导致整个连接过程中断。

**复现步骤**:
1. 配置主网节点地址（QUIC 协议）
2. 启动 pool-server
3. 观察连接失败

**预期行为**:
本地节点应该成功连接到主网节点，无论协议是否完全匹配。

**实际行为**:
由于协议不匹配或配置错误，连接失败。

**可能的解决方案**:
1. 修改本地节点配置，确保使用与主网节点相同的协议
2. 实现协议协商机制，自动选择兼容的协议
3. 在连接失败时提供更详细的错误信息

**优先级**: 中高
**标签**: bug, connectivity, p1

---

### Issue #4: 缺少区块链同步逻辑 (clear) ✅

**标题**: 缺少有效的区块链同步逻辑导致无法获取主网状态

**描述**:
在代码中，`get_chain_state` 方法首先检查环境变量中的难度目标，如果存在则直接使用，而不是从主网同步真实的区块链状态。这导致系统使用本地配置而非主网状态。

**复现步骤**:
1. 设置环境变量 `DIFFICULTY_TARGET`
2. 启动 pool-server
3. 观察系统使用环境变量中的难度目标而非主网难度

**预期行为**:
系统应该从主网同步真实的区块链状态，包括难度目标。

**实际行为**:
系统优先使用环境变量中的配置，忽略主网状态。

**可能的解决方案**:
1. 修改 `get_chain_state` 方法，优先从主网获取状态
2. 添加同步检查机制，确保本地状态与主网一致
3. 在日志中清晰显示是使用本地配置还是主网状态

**优先级**: 中高
**标签**: bug, synchronization, p1

---

## 严重级别 P2（中等问题）

### Issue #5: 难度设置问题

**标题**: 难度设置可能不符合主网要求

**描述**:
虽然在环境变量中设置了难度目标，但系统可能仍然使用 fakenet 的默认难度计算方式。日志中显示的难度目标与环境变量中设置的一致，但可能不是主网的实际难度。

**复现步骤**:
1. 设置环境变量 `DIFFICULTY_TARGET`
2. 启动 pool-server
3. 观察系统使用的难度目标

**预期行为**:
系统应该使用主网的实际难度目标。

**实际行为**:
系统使用环境变量中设置的难度目标，可能与主网不一致。

**可能的解决方案**:
1. 添加从主网获取实际难度的逻辑
2. 实现难度自动调整机制
3. 在连接主网时忽略环境变量中的难度设置

**优先级**: 中
**标签**: enhancement, mining, p2

---

### Issue #6: 网络类型检测逻辑不完善

**标题**: 网络类型检测逻辑不完善导致可能仍以 fakenet 模式运行

**描述**:
虽然在配置中设置了 `fakenet: false`，但系统可能在其他地方有检测逻辑，导致仍然以 fakenet 模式运行。

**复现步骤**:
1. 设置 `fakenet: false`
2. 启动 pool-server
3. 观察系统行为是否符合主网模式

**预期行为**:
系统应该完全以主网模式运行。

**实际行为**:
系统可能混合使用主网和 fakenet 的行为。

**可能的解决方案**:
1. 全面检查代码中的网络类型检测逻辑
2. 统一网络类型配置，避免多处定义
3. 添加网络类型日志，清晰显示当前运行模式

**优先级**: 中
**标签**: bug, configuration, p2

---

### Issue #7: 缺少主网同步进度日志

**标题**: 缺少主网同步进度日志导致无法监控同步状态

**描述**:
正常情况下，连接到主网后应该有同步区块的日志，但目前的日志中没有任何区块同步的信息，这表明可能根本没有开始同步过程，或者同步过程没有产生日志。

**复现步骤**:
1. 配置主网连接
2. 启动 pool-server
3. 观察日志中缺少同步信息

**预期行为**:
日志中应该显示区块同步的进度和状态。

**实际行为**:
日志中没有区块同步的信息。

**可能的解决方案**:
1. 添加详细的同步进度日志
2. 实现同步状态监控机制
3. 在 HTTP API 中提供同步状态查询接口

**优先级**: 中
**标签**: enhancement, logging, p2

---

## 严重级别 P3（低优先级问题）

### Issue #8: 环境变量覆盖问题

**标题**: 环境变量可能覆盖代码中的配置设置

**描述**:
虽然在 `main.rs` 中设置了 `fakenet: false`，但可能有环境变量或其他配置覆盖了这个设置。

**复现步骤**:
1. 在代码中设置 `fakenet: false`
2. 设置环境变量 `FAKENET=true`
3. 启动 pool-server
4. 观察系统行为

**预期行为**:
系统应该有明确的配置优先级，避免意外覆盖。

**实际行为**:
不同来源的配置可能相互覆盖，导致行为不一致。

**可能的解决方案**:
1. 明确配置优先级规则
2. 在启动时记录所有有效配置
3. 检测并警告配置冲突

**优先级**: 低
**标签**: enhancement, configuration, p3

---

### Issue #9: 缺少定期同步机制

**标题**: 缺少有效的定期同步机制

**描述**:
虽然代码中有定期检查区块链状态的任务，但日志中只显示了一次 `执行定期区块链状态检查`，之后没有更多的检查记录，这可能表明定期检查任务没有正常运行。

**复现步骤**:
1. 启动 pool-server
2. 运行一段时间（超过检查间隔）
3. 观察日志中缺少定期检查记录

**预期行为**:
系统应该按照设定的间隔定期检查区块链状态。

**实际行为**:
只有一次初始检查，之后没有更多检查记录。

**可能的解决方案**:
1. 修复定期检查任务
2. 添加任务健康监控机制
3. 实现更可靠的定时器

**优先级**: 低
**标签**: enhancement, synchronization, p3

---

### Issue #10: libp2p 驱动初始化问题

**标题**: libp2p 驱动初始化状态不一致

**描述**:
虽然日志显示 `driver 'libp2p' initialized`，但在此之前已经报错，表明 swarm 创建失败。这意味着 libp2p 驱动可能没有正确初始化，但系统仍然报告初始化成功。

**复现步骤**:
1. 启动 pool-server
2. 观察日志中的矛盾信息

**预期行为**:
如果 swarm 创建失败，系统应该报告驱动初始化失败。

**实际行为**:
系统报告驱动初始化成功，但实际上 swarm 创建已经失败。

**可能的解决方案**:
1. 修复错误处理逻辑，确保状态一致
2. 添加更详细的初始化状态检查
3. 改进日志记录，避免混淆信息

**优先级**: 低
**标签**: bug, initialization, p3 